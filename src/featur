from behave import given, when, then
from features.pages.catalog_page import CatalogPage
"""
@given("I open the app")
def open_app(context):
    context.page.goto(context.base_url)
    context.catalog = CatalogPage(context.page)
"""
# NAVIGATION
# 1. navigate to the add book page
# US-4_AC1.
@when("I click the 'Lägg till bok' navigation button")
def click_add_book(context):
    #context.catalog = CatalogPage(context.page)
    context.addbook = CatalogPage(context.page)
    context.addbook.click_add_book_nav()

# INPUTS
# 2. Verify that you are on the right page
# US-2_AC1
@then("I should see inputs for title and author")
def see_inputs(context):
    assert context.page.locator('input[data-testid="add-input-title"]').is_visible()
    assert context.page.locator('input[data-testid="add-input-author"]').is_visible()

# FILL FORM
# 3. Enter the new book title and Author
# US-2_AC2
@when('I fill Titel "{title}" and Författare "{author}"')
def fill_form(context, title, author):
    context.page.fill('input[data-testid="add-input-title"]', title)
    context.page.fill('input[data-testid="add-input-author"]', author)
    # enable submit if it was disabled by the app's logic (but the app normally enables it)
    # click submit
    # The submit button is activated by typing ib both Titel and author fields

# SUBMIT FORM
# 4. Click the "Lägg till ny bok" button to confirm your entry
# US-2_AC3
@then('I click the "Lägg till ny bok" button')
@when('I click the "Lägg till ny bok" button')
def submit_entry(context):
    btn = context.page.locator('button[data-testid="add-submit"]')
    if btn.get_attribute('disabled'):
        # if disabled, attempt to enable by typing; but normally typing will enable it
       pass
    btn.click()

# GO TO CATALOG
# 5. Navigate back to 'Katalog' page to check the new entry
# US-4_AC3
@then("I navigate to the katalog")
@when("I navigate to the katalog")
def goto_catalog(context):
    context.catalog = CatalogPage(context.page)
    context.catalog.click_catalog_nav()


# WAIT
# 6. ensure that we are on the right page by waiting for it to load
@then("I should be on the katalog page")
def step_verify_catalog_page(context):
    context.catalog.wait_until_loaded()


# VERIFY LAST BOOK
# 7, Verify the book is added
# US-2_AC4
@then('the last book in the catalog should be \'{expected}\'')
def check_last_book_exact(context, expected):
    # ensure we are on catalog
    context.catalog = CatalogPage(context.page)
    
    # identify the last book in the catalog
    last_book = context.catalog.last_catalog_item_text()
    #assert expected in last, f"Expected '{expected}' in last catalog item but got: {last}"
    assert expected in last_book, f"Expected '{expected}' to be in the last catalog item but got: {last_book}"

"""
@then('the last book in the catalog should be \'"<title>", <author>\'')
def step_outline_last_book(context, title, author):
    context.catalog = CatalogPage(context.page)
    expected = f'"{title}", {author}'
    last_book = context.catalog.last_catalog_item_text()
    assert last_book == expected, \
        f"Expected last book '{expected}' but got '{last_book}'"
"""


# COUNT CHECK
@then("the catalog should contain at least {min_count:d} books")
def check_catalog_count(context, min_count):
    count = context.catalog.catalog_count()
    assert count >= min_count, f"Expected at least {min_count} books but found {count}"

"""
@then("the catalog should contain at least 10 books")
def step_catalog_size(context):
    context.catalog = CatalogPage(context.page)
    count = context.catalog.catalog_count()
    assert count >= 10, \
    f"Expected >= 10 books but found {count}"
"""

